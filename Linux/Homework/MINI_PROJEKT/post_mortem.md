################# POST MORTEN #######################

### РАЗДЕЛ №1. КРАТКОЕ ОПИСАНИЕ
- Сайт с которым возникла проблема: http://3.73.44.38
- Первичная проблема: `Отсутствие доступа к сайту`
- Время обнаружение первичной проблемы: `2024-10-28 09:00`
- Время исправления проблем: `2024-10-28 9:38`
- Сотрудник обнаруживший проблему: `Мутаф Владимир`
- Сотрудник которому было поручено исправить проблему: `Мутаф Владимир`
- Куратор: `Чумак Иван`

#### Выявленные проблемы:
1. Файл `/var/www/html/mediawiki/LocalSettings.php` был пуст
2. Полностью заполнено дисковое пространство из-за файла `access_log`.
3. Наличие в планировщике `cron` команды архивации (`tar`) которая отрабатывала ежесекундно и была некорректной
3. Наличие в резервной копии файла `LocalSettings.php` некорректной ссылки на сервер


### РАЗДЕЛ №2. ПОДРОБНОЕ ОПИСАНИЕ

| Дата и время                      | Описание события                                                                                                                                  |
|-----------------------------------|---------------------------------------------------------------------------------------------------------------------------------------------------|
| **2024-10-28 09:00**              | Прибыв на рабочее место, обнаружено проблему: <br/>отсутствие доступа к сайту http://3.73.44.38                                                   |
| **2024-10-28 09:01**              | Созвон с непосредственным руководителем Чумаком Иваном, описана проблема. <br/>Поручено восстановить сайт в кратчайшие сроки применяя любые методы |
| **2024-10-28 09:02**              | Предпринята попытка входа на сервер [1]. <br/>Результат: успешно                                                                                |
| **2024-10-28 09:02**              | Проверка статуса процесса `httpd` [2]. <br/>Результат: active (running)                                                                           |
| **2024-10-28 09:03**              | Проверка файла с настройками приложения `LocalSettings.php` [3]. <br/>Результат: файл пуст                                                        |
| **2024-10-28 <br/>09:03 - 09:05** | Созвон с сисадмином Негодяйченко Алексеем. <br/>Результат: Получена информация о наличии резервной копии этого файла                              |
| **2024-10-28 09:06**              | Попытка чтения резервной копии `LocalSettings_reserv.php` [4]. <br/>Результат: Невозможно выполнить из-за отсутствия места на жестком диске сервера |
| **2024-10-28 09:06**              | Проверка дискового пространства сервера [5]. <br/>Результат: Полное заполнение `/dev/nvme0n1p1 10G 10G 0 100%`                                    |
| **2024-10-28 09:07**              | Поиск крупных файлов [6]. <br/>Результат: огромный вывод директорий с ограничением доступа                                                        |
| **2024-10-28 09:07**              | Принято решение использовать `sudo` для поиска [7]. <br/>Результат: найден файл `access_log` размером `7.0G`                                      |
| **2024-10-28 09:08**              | Созвон с непосредственным руководителем Чумаком Иваном.<br/>Результат: поставлена задача сохранить файл `access_log`                                  |
| **2024-10-28 <br/>09:08 - 09:15** | Скачивание файла `access_log` на локальный компьютер [8]. <br/>Результат: успешно                                                                 |
| **2024-10-28 09:16**              | Удаление содержимого `/var/log/httpd/access_log` [9].<br/> Результат: успешно                                                                     |
| **2024-10-28 09:17**              | Повторная попытка чтения `LocalSettings_reserv.php` [4]. <br/>Результат: файл содержит настройки приложения                                       |
| **2024-10-28 09:18**              | Восстановление содержимого `LocalSettings.php` [10]. <br/>Результат: отказано в доступе                                                           |
| **2024-10-28 09:19**              | Проверка прав на файлы `LocalSettings.php` и `LocalSettings_reserv.php` [11][12]                                                                  |
| **2024-10-28 09:20**              | Повторная попытка восстановления `LocalSettings.php` с `sudo` [13]. <br/>Результат: отказано в доступе                                            |
| **2024-10-28 09:21**              | Переход в оболочку `root` [15]. <br/>Результат: успешно                                                                                           |
| **2024-10-28 09:21**              | Попытка восстановление содержимого файла LocalSettings.php в режиме суперпользователя [10].<br/>Результат: успешно                                |                                                          |
| **2024-10-28 09:22**              | Проверка сайта http://3.73.44.38. <br/>Результат: неуспешно                                                                                       |
| **2024-10-28 <br/>09:22 - 09:24** | Поиск проблемы [3]. <br/>Результат: неверный адрес "https://18.153.51.162" в переменной `$wgServer `                                              |
| **2024-10-28 <br/>09:22 - 09:25** | Исправление переменной `$wgServer` в `LocalSettings.php` [16]. <br/>Результат: успешно                                                            |
| **2024-10-28 09:26**              | Проверка доступа к сайту. <br/>Результат: успешно                                                                                                 |
| **2024-10-28 09:27**              | Проверка дискового пространства. <br/>Результат: 60% свободно. Обнаружена быстрая заполняемость                                                   |
| **2024-10-28 09:28**              | Проверка планировщика `cron` [17]. <br/>Результат: некорректная команда архивации <br/>`log_$(date +\%Y\%m\%d).tar.gz -C /var/log/httpd  `        |
| **2024-10-28 09:29**              | Остановка некорректной `cron`-задачи [18]. <br/>Результат: успешно                                                                                |
| **2024-10-28 <br/>09:30 - 09:36** | Создание скрипта для архивирования `access_log` [19][20][21][22]. <br/>Результат: успешно                                                         |
| **2024-10-28 09:37**              | Установка корректной задачи в `cron` для архивации каждые 24 часа [18]. <br/>Результат: успешно                                                   |
| **2024-10-28 09:38**              | Выход из режима `root` [23]. <br/>Результат: успешно                                                                                              |
| **2024-10-28 09:39**              | Созвон с Чумаком Иваном с устным отчетом об успехе                                                                                                |



### РАЗДЕЛ 3. ИТОГОВЫЙ РЕЗУЛЬТАТ

1. Доступ к сайту http://3.73.44.38 востановлен 2024-10-28 9:26
2. Содержимое файла `access_log` сохранено
3. Установлена корректная задача в `cron` по архивации логов


### РАЗДЕЛ 4. ИСПОЛЬЗОВАНЫЕ КОМАНДЫ

1. `ssh -i ich.pem ec2-user@3.73.44.38`
2. `service httpd status`
3. `cat /var/www/html/mediawiki/LocalSettings.php`
4. `cat /reserv_files/LocalSettings_reserv.php`
5. `df -h`
6. `find / -type f -size +100M -exec du -h {} +`
7. `sudo find / -type f -size +100M -exec du -h {} +`
8. `scp -i ich.pem ec2-user@3.73.44.38:/var/log/httpd/access_log  /reserv_file`
9. `echo "" >  /var/log/httpd/access_log`
10. `cp /reserv_files/LocalSettings_reserv.php  /var/www/html/mediawiki/LocalSettings.php`
11. `ls -l /reserv_files/LocalSettings_reserv.php`
12. `ls -l /var/www/html/mediawiki/LocalSettings.php`
13. `sudo cp /reserv_files/LocalSettings_reserv.php  /var/www/html/mediawiki/LocalSettings.php`
14. `sudo -l`
15. `sudo su`
16. `vi /var/www/html/mediawiki/LocalSettings.php`
17. `crontab -l`
18. `crontab -e`
19. `сd /home/ec2-user/`
20. `> backup_logs.sh`
21. `chmod 744 backup_logs.sh`
22. `vi 744 backup_logs.sh`
23. `exit`


### РАЗДЕЛ 5. ПРЕДЛОЖЕНИЯ ПО УЛУЧШЕНИЮ РАБОТЫ СЕРВЕРА

1. Сервер не имеет системы оповещения о критической ситуации с заполнением хранилища.

   >Я создал заготовку скрипта, который проверяет заполнесть хранилища.
   Скрипт нужно дополнить кодом который в случае достижения критической отметки уведомит
   ответственных лиц об угрозе.

   https://github.com/Mutaf-Volodymyr/My_education/blob/main/Linux/Homework/MINI_PROJEKT/memory.sh

   >После определения ответственных лиц, и доработки скрипта, его нужно добавить в планировщик cron


2. Сервер не имеет системы оповещения о доступе к веб-cайту.

   >В нашей компании есть четыре сервера, каждый из которых имеет аналогчиную пролему.
   Я подготовил небольшой скрипт, который так же необходимо доработать, после определения концепции
   способа отправки и круга ответственных лиц.
   Идея заключается в том, что бы каждый сервер следил за соседнем в замкнутой системе,
   и отправлял сообщения об ошибке в случае утраты доступа одному из веб-сайтов:

       Server1 ______ Server2
            |           |
            |           |
       Server4 ______ Server3

   https://github.com/Mutaf-Volodymyr/My_education/blob/main/Linux/Homework/MINI_PROJEKT/use_web.sh

>> Применив эти два небольших скрипта мы значительно улучшим качество нашего продукта. Первый скрипт поможет предотвращать
значительную часть проблем с доступом на веб-сайт еще до момента их возникновения (профилактика проблемы).
Второй скрип поможет быстро узнавать о проблеме. Вышеописанная система "надзора сервера за другим сервером" позволит получать уведомления,
не только в случаеях который описаны выше (очистка файла LocalSettings.php или неправильный путь в переменной $wgServer), но и в случае
полной утраты функциональности сервера.
Эти два изменения не требуют финансовых вливаний. Так же у меня есть другие, финансово затратные решения
(например динамическое пространство на серверах Амазон, бэкап всей системы и другое), которые я готов обсудить на очередном митинге.